name: 'test'
on:
  push:
jobs:
  pnpm-monorepo:
    runs-on: ubuntu-latest
    container:
      image: onthertech/titan-ci-builder:latest
    steps:
    - uses: actions/checkout@v4.1.0
     # Declares the repository safe and not under dubious ownership.
    - name: Add repository to git safe directories
      run: git config --global --add safe.directory $GITHUB_WORKSPACE
    - name: restore_cache
      uses: actions/cache@v3.3.2
      with:
        key: pnpm-packages-v2-{{ checksum "pnpm-lock.yaml" }}
        path: node_modules
        restore-keys: pnpm-packages-v2-{{ checksum "pnpm-lock.yaml" }}
    - name: Fetch dependencies
      run: pnpm fetch --frozen-lockfile --prefer-offline
    - name: Install dependencies
      run: pnpm install --frozen-lockfile --offline
    - name: print forge version
      run: forge --version
    - name: Build monorepo
      run: pnpm build
    - uses: actions/upload-artifact@v4.0.0
      with:
        path: |-
          ./packages/**/dist
          ./packages/contracts-bedrock/forge-artifacts
  contracts-bedrock-tests:
    runs-on: ubuntu-latest
    container:
      image: onthertech/titan-ci-builder:latest
    steps:
    - uses: actions/checkout@v4.1.0
    - name: 'Check changed'
      run: |
        cd ops/check-changed
        pip3 install -r requirements.txt
        python3 main.py "contracts-bedrock,op-node"
    - name: print forge version
      run: forge --version
      working-directory: packages/contracts-bedrock
    - name: run tests
      run: pnpm test
      working-directory: packages/contracts-bedrock
      env:
        FOUNDRY_PROFILE: ci
  contracts-bedrock-coverage:
    runs-on: ubuntu-latest
    container:
      image: onthertech/titan-ci-builder:latest
    steps:
    - uses: actions/checkout@v4.1.0
    - name: 'Check changed'
      run: |
        cd ops/check-changed
        pip3 install -r requirements.txt
        python3 main.py "contracts-bedrock,op-node"
     # Declares the repository safe and not under dubious ownership.
    - name: Add repository to git safe directories
      run: git config --global --add safe.directory $GITHUB_WORKSPACE
    - name: restore_cache
      uses: actions/cache@v3.3.2
      with:
       key: pnpm-packages-v2-{{ checksum "pnpm-lock.yaml" }}
       path: node_modules
       restore-keys: pnpm-packages-v2-{{ checksum "pnpm-lock.yaml" }}
    - name: Fetch dependencies
      run: pnpm fetch --frozen-lockfile --prefer-offline
    - name: Install dependencies
      run: pnpm install --frozen-lockfile --offline
    - name: print forge version
      run: forge --version
      working-directory: packages/contracts-bedrock
    - name: test and generate coverage
      run: pnpm coverage:lcov
      working-directory: packages/contracts-bedrock
      env:
        FOUNDRY_PROFILE: ci
    - name: upload coverage
      run: codecov --verbose --clean --flags contracts-bedrock-tests
      env:
        FOUNDRY_PROFILE: ci